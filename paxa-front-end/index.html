<!DOCTYPE html>
<html>
  <head>
    <title>SSDK bokning</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" href="style.css" media="screen" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <link rel="stylesheet" href="jquery-ui/jquery-ui.min.css">
    <script src="jquery-ui/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="timepicker/jquery.timepicker.css">
    <script src="timepicker/jquery.timepicker.min.js"></script>

  </head>
  <body>
  <div id="wrap">
    <div id="top"></div>

      <div id="content">
      <div class="header">
        <h1>SSDK bokning</h1>
      </div>

      <div class="middle" id="booking_list">
        <label for="date" style="display: block">Visar bokningar för datum: </label>
        <input type="text" name="date" id="date"/>
          <br />
          <br />
          <button id="new_booking_btn" class="ui-button ui-widget ui-corner-all">Ny bokning</button>
          <div id="currentBookings" style="padding-top: 2em;"></div>
      </div>

      <div class="middle" id="booking_create">
          <div id="new_booking_date"></div>

          <label for="resource_select" style="display:block">Välj en resurs</label>
          <select id="resource_select"></select>
          <br />
          <br />
          <label for="fromTime" style="display: block">Från: </label>
          <input id="fromTime" type="text" class="time" style="vertical-align: top" />
          <br />
          <label for="toTime" style="display: block">Till: </label>
          <input id="toTime" type="text" class="time" style="vertical-align: top" />
          <br />
          <br />
          <button id="cancel_book_btn" class="ui-button ui-widget ui-corner-all">Avbryt</button>
          <button id="book_btn" class="ui-button ui-widget ui-corner-all"><strong>Boka</strong></button>
      </div>

      <div id="clear"></div>

    </div>

    <div id="bottom"></div>

  </div>

  <div id="footer">
      <a href="http://www.ssdk-karlshamn.se/">SSDK hemsida</a>
  </div>

  <div id="deleteBookingDialog" title="Radera bokning?"></div>

  <script>
    var defaultStartTime = new Date();
    defaultStartTime.setHours(12, 0, 0, 0);

    $(document).ready(function(){
      $("#booking_create").toggle();

      loadExistingBookings(new Date());

      // Read all bookable resources from DB.
      $.getJSON('http://localhost:8080/paxa/allResources', populateSelectBox);

      //Reset timepickers to default value
      resetBookingFields();
    });

    $("#date").datepicker({
      dateFormat: "yy-mm-dd",
      defaultDate: +0,
      firstDay: 1,
      buttonImage: "http://jqueryui.com/resources/demos/datepicker/images/calendar.gif",
      buttonImageOnly: true,
      showOn: "both",
      autoSize: true
    });

    $("#date").datepicker('setDate', new Date());

    $("#date").on("change",function(){
        var selected = $(this).val();
        loadExistingBookings(new Date(selected));
    });

    $("#new_booking_btn").click(function () {
      var currentDate = $("#date").val();
      $("#new_booking_date").empty().append('Bokar för: <b>' + currentDate + '</b>');

      $( "#booking_list" ).toggle();
      $( "#booking_create" ).toggle();
    });

    $("#book_btn").click(function () {
      var currentDate = $("#date").val();
      var startTime = $('#fromTime').timepicker('getTime', currentDate);
      var endTime = $('#toTime').timepicker('getTime', currentDate);

      var selectElem = document.getElementById("resource_select");
      var selectedResource = selectElem.options[selectElem.selectedIndex].value;

      //Create new booking
      createNewBooking(selectedResource, startTime, endTime);

      resetBookingFields();
      $( "#booking_list" ).toggle();
      $( "#booking_create" ).toggle();
    });

    $("#cancel_book_btn").click(function () {
      resetBookingFields();
      $( "#booking_list" ).toggle();
      $( "#booking_create" ).toggle();
    });

    $('#fromTime').timepicker({
      'timeFormat': 'H:i'
    });

    $('#toTime').timepicker({
      'timeFormat': 'H:i'
    });

    function resetBookingFields() {
      $('#resource_select').prop('selectedIndex',0);
      $('#fromTime').timepicker('setTime', defaultStartTime);
      $('#toTime').timepicker('setTime', defaultStartTime);
    }

    function loadExistingBookings(date) {
      $.getJSON('http://localhost:8080/paxa/bookingsAtDate/?date=' + formatDate(date), populateBookingsDiv(date))
    }

    function populateSelectBox(data) {
      var select = document.getElementById("resource_select");
      for(var i = 0; i < data.length; i++) {
        var el = document.createElement("option");
        el.textContent = data[i].name;
        el.value = data[i].id;
        select.appendChild(el);
      }
    }

    function populateBookingsDiv(currentDate) {
      return function(data) {
        var table = document.createElement("table");
        table.innerHTML = "<th>Objekt</th><th style=\"padding: 0 2em 0 2em;\">Starttid</th><th>Sluttid</th>";
        for(var i = 0; i < data.length; i++) {
          var row = document.createElement("tr");
          var col1 = document.createElement("td");
          col1.innerHTML = data[i].resource.name;
          var col2 = document.createElement("td");
          col2.innerHTML = convertTimeStrWithDay(data[i].startTime, currentDate);
          col2.style.padding = "0 2em 0 2em";
          var col3 = document.createElement("td");
          col3.innerHTML = convertTimeStrWithDay(data[i].endTime, currentDate);
          var col4 = document.createElement("td");
          var btnSpan = document.createElement("span");
          btnSpan.setAttribute("class", "ui-icon ui-icon-trash");
          var delBtn = document.createElement("button");
          delBtn.setAttribute("id", "delete_booking_btn" + i);
          delBtn.setAttribute("onclick", "alertDeleteBooking(" + data[i].id + ")");
          delBtn.appendChild(btnSpan);
          col4.appendChild(delBtn);

          row.appendChild(col1);
          row.appendChild(col2);
          row.appendChild(col3);
          row.appendChild(col4);
          table.appendChild(row);
        }
        var bookingsDiv = document.getElementById("currentBookings");
        bookingsDiv.innerHTML = "";
        bookingsDiv.appendChild(table);
      };
    }

    function createNewBooking(selectedResource, startTime, endTime) {
      var json = newBookingJson();
      json.resource.id=selectedResource;
      json.startTime=startTime.getTime();
      json.endTime=endTime.getTime();

      $.ajax({
      type: "POST",
      url: "http://localhost:8080/paxa/createNewBooking",
      data: JSON.stringify(json),
      success: createOrDeleteBookingSuccess,
      dataType: "json",
      contentType: "application/json; charset=utf-8",
      cache: false,
      processData: false
      });
    }

    function createOrDeleteBookingSuccess(data, status) {
      var currentDate = $("#date").val();
      loadExistingBookings(new Date(currentDate));
    }

    function newBookingJson() {
      return {
        resource: {
          id:null
        },
        startTime:null,
        endTime:null
      }
    }

    function alertDeleteBooking(id) {
      $("#deleteBookingDialog").dialog({

        buttons: {
          Ja: function () {
            $.ajax({
              url: "http://localhost:8080/paxa/deleteBooking",
              type: "DELETE",
              data: JSON.stringify(id),
              success: createOrDeleteBookingSuccess,
              dataType: "json",
              contentType: "application/json; charset=utf-8"
            });
            $(this).dialog("close");
          },
          Nej: function () {
            $(this).dialog("close");
          }
        }
      });
    }

    function convertTimeStr(dateMillis) {
      var date = new Date(dateMillis);
      return addZero(date.getHours()) + ":" + addZero(date.getMinutes());
    }

    function convertTimeStrWithDay(dateMillis, selectedDate) {
      var date = new Date(dateMillis);
      if(!sameDay(date, selectedDate)) {
        return formatDate(date) + "  " + addZero(date.getHours()) + ":" + addZero(date.getMinutes());
      }
      else {
        return addZero(date.getHours()) + ":" + addZero(date.getMinutes())
      }
    }

    function sameDay(d1, d2) {
      return (d1.toDateString() === d2.toDateString());
    }

    function addZero(i) {
      if (i < 10) {
        i = "0" + i;
      }
      return i;
    }

    function formatDate(date) {
      month = '' + (date.getMonth() + 1),
      day = '' + date.getDate();
      year = date.getFullYear();
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;

      return [year, month, day].join('-');
    }

  </script>
  </body>
</html>